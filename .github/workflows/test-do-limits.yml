name: Test do-limits.sh Script

on:
  pull_request:
    paths:
      - 'docker/do-limits.sh'
  push:
    branches:
      - 'fix/do-limits-setup'
    paths:
      - 'docker/do-limits.sh'

jobs:
  test-do-limits:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

    - name: Verify Docker installation
        run: |
          docker --version
          docker compose version

      - name: Make script executable
        run: chmod +x docker/do-limits.sh
        shell: bash

      - name: Create test environment files
        run: |
          # Create minimal docker-compose.yml for testing
          cat > docker/docker-compose.yml << 'EOF'
          version: '3.8'
          services:
            test-service:
              image: alpine:latest
              command: sleep 3600
              container_name: test-container
          EOF
        shell: bash

      - name: Test script help
        run: |
          cd docker
          ./do-limits.sh --help
        shell: bash

      - name: Test script list plans
        run: |
          cd docker
          ./do-limits.sh --list
        shell: bash

      - name: Test unlimited plan (all platforms)
        run: |
          cd docker
          echo "Testing unlimited plan..."
          ./do-limits.sh unlimited --dry-run || true
          # Check if script executed without syntax errors
          echo "Unlimited plan test completed"
        shell: bash

      - name: Test 512mb plan
        run: |
          cd docker
          echo "Testing 512mb plan..."
          ./do-limits.sh 512mb --dry-run || true
          echo "512mb plan test completed"
        shell: bash

      - name: Test 1gb plan
        run: |
          cd docker
          echo "Testing 1gb plan..."
          ./do-limits.sh 1gb --dry-run || true
          echo "1gb plan test completed"
        shell: bash

      - name: Test 2gb plan
        run: |
          cd docker
          echo "Testing 2gb plan..."
          ./do-limits.sh 2gb --dry-run || true
          echo "2gb plan test completed"
        shell: bash

      - name: Test 4gb plan
        run: |
          cd docker
          echo "Testing 4gb plan..."
          ./do-limits.sh 4gb --dry-run || true
          echo "4gb plan test completed"
        shell: bash

      - name: Test invalid plan
        run: |
          cd docker
          echo "Testing invalid plan..."
          ./do-limits.sh invalid-plan --dry-run || echo "Expected failure for invalid plan"
          echo "Invalid plan test completed"
        shell: bash

      - name: Test systemd detection (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd docker
          echo "Testing systemd detection on Linux..."
          # Test the has_systemd function indirectly by running a plan
          ./do-limits.sh 1gb --dry-run || true
          echo "Systemd detection test completed"
        shell: bash

      - name: Test non-systemd path (macOS only)
        if: matrix.os == 'macos-latest'
        run: |
          cd docker
          echo "Testing non-systemd path on macOS..."
          # macOS should use the fallback path
          ./do-limits.sh 1gb --dry-run || true
          echo "macOS non-systemd test completed"
        shell: bash

      - name: Test Windows compatibility
        if: matrix.os == 'windows-latest'
        run: |
          cd docker
          echo "Testing Windows compatibility..."
          # Test basic script functionality on Windows
          ./do-limits.sh --help
          ./do-limits.sh --list
          echo "Windows compatibility test completed"
        shell: bash

      - name: Validate script syntax
        run: |
          cd docker
          echo "Validating shell script syntax..."
          bash -n do-limits.sh
          echo "Syntax validation passed"
        shell: bash

      - name: Check for common issues
        run: |
          cd docker
          echo "Checking for common script issues..."

          # Check for proper line endings
          if file do-limits.sh | grep -q "CRLF"; then
            echo "WARNING: File has CRLF line endings"
          fi

          # Check for executable permission
          if [ -x do-limits.sh ]; then
            echo "✓ Script is executable"
          else
            echo "✗ Script is not executable"
            exit 1
          fi

          # Check for basic required functions
          if grep -q "has_systemd" do-limits.sh; then
            echo "✓ Systemd detection function found"
          else
            echo "✗ Systemd detection function missing"
            exit 1
          fi

          echo "Common issues check completed"
        shell: bash

      - name: Test resource limit configurations
        run: |
          cd docker
          echo "Testing resource limit configurations..."

          # Test that all expected plans are available
          expected_plans=("512mb" "1gb" "2gb" "4gb" "unlimited")

          for plan in "${expected_plans[@]}"; do
            echo "Testing plan: $plan"
            if ./do-limits.sh $plan --dry-run 2>/dev/null; then
              echo "✓ Plan $plan is valid"
            else
              echo "⚠ Plan $plan failed (may be expected on some platforms)"
            fi
          done

          echo "Resource limit configurations test completed"
        shell: bash