name: Test do-limits.sh Script

on:
  pull_request:
    paths:
      - 'docker/do-limits.sh'
  push:
    branches:
      - 'fix/do-limits-setup'
    paths:
      - 'docker/do-limits.sh'

jobs:
  test-do-limits:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check Docker availability
        run: |
          if command -v docker >/dev/null 2>&1; then
            echo "Docker is available"
            docker --version
            if command -v docker-compose >/dev/null 2>&1; then
              docker-compose --version
            else
              docker compose version
            fi
          else
            echo "Docker is not available on this runner"
            echo "Skipping Docker-dependent tests"
            echo "skip_docker_tests=true" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Make script executable
        run: chmod +x docker/do-limits.sh
        shell: bash

      - name: Create test environment files
        if: env.skip_docker_tests != 'true'
        run: |
          # Create minimal docker-compose.yml for testing
          cat > docker/docker-compose.yml << 'EOF'
          version: '3.8'
          services:
            test-service:
              image: alpine:latest
              command: sleep 3600
              container_name: test-container
          EOF
        shell: bash

      - name: Test script help
        run: |
          cd docker
          ./do-limits.sh --help
        shell: bash

      - name: Test script list plans
        run: |
          cd docker
          ./do-limits.sh --list
        shell: bash

      - name: Test script plan validation
        run: |
          cd docker
          echo "Testing plan validation logic..."

          # Test that all expected plans are recognized by the script
          expected_plans=("512mb" "1gb" "2gb" "4gb" "unlimited")

          for plan in "${expected_plans[@]}"; do
            echo "Testing plan: $plan"

            # Test that get_plan_info function returns info for each plan
            plan_info=$(bash -c "source ./do-limits.sh 2>/dev/null; get_plan_info '$plan'" || echo "")
            if [ -n "$plan_info" ]; then
              echo "  ✓ Plan $plan found: $plan_info"
            else
              echo "  ✗ Plan $plan not found or invalid"
              exit 1
            fi
          done

          echo "Plan validation test completed"
        shell: bash

      - name: Test invalid plan
        run: |
          cd docker
          echo "Testing invalid plan..."
          # Test that invalid plan returns empty info
          plan_info=$(bash -c "source ./do-limits.sh 2>/dev/null; get_plan_info 'invalid-plan'" || echo "")
          if [ -z "$plan_info" ]; then
            echo "✓ Invalid plan correctly rejected"
          else
            echo "✗ Invalid plan was accepted: $plan_info"
            exit 1
          fi

          # Test invalid command handling
          if ./do-limits.sh invalid-command 2>/dev/null; then
            echo "✗ Invalid command should have failed"
            exit 1
          else
            echo "✓ Invalid command correctly rejected"
          fi

          echo "Invalid plan test completed"
        shell: bash

      - name: Test systemd detection function (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd docker
          echo "Testing systemd detection function..."

          # Extract and test the has_systemd function
          if grep -q "has_systemd()" do-limits.sh; then
            echo "✓ has_systemd() function found"

            # Test systemd detection logic manually
            if command -v systemctl >/dev/null 2>&1 && [ -d /etc/systemd/system ]; then
              echo "✓ Systemd detected on this runner"
              echo "✓ Cross-platform systemd detection working"
            else
              echo "⚠ Systemd not detected (expected on some runners)"
            fi
          else
            echo "✗ has_systemd() function missing"
            exit 1
          fi

          echo "Systemd detection test completed"
        shell: bash

      - name: Test systemd slice file generation (Linux only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd docker
          echo "Testing systemd slice file generation..."

          # Test slice file content generation logic
          mem_limit="1G"
          cpu_quota="200%"
          slice_name="test-slice"

          # Create test slice file content
          echo '[Unit]' > test_slice.slice
          echo 'Description=Test Resource Limited Slice (test RAM, test CPU)' >> test_slice.slice
          echo 'Before=slices.target' >> test_slice.slice
          echo 'Documentation=man:systemd.slice(7)' >> test_slice.slice
          echo '' >> test_slice.slice
          echo '[Slice]' >> test_slice.slice
          echo 'MemoryMax=1G' >> test_slice.slice
          echo 'CPUQuota=200%' >> test_slice.slice

          # Validate slice file structure
          if grep -q "\[Unit\]" test_slice.slice && \
             grep -q "\[Slice\]" test_slice.slice && \
             grep -q "MemoryMax=1G" test_slice.slice && \
             grep -q "CPUQuota=200%" test_slice.slice; then
            echo "✓ Slice file generation logic working"
          else
            echo "✗ Slice file generation failed"
            exit 1
          fi

          # Test parent slice generation
          echo '[Unit]' > test_parent.slice
          echo 'Description=Supabase Services Slice' >> test_parent.slice
          echo 'Before=slices.target' >> test_parent.slice
          echo 'Documentation=man:systemd.slice(7)' >> test_parent.slice
          echo '' >> test_parent.slice
          echo '[Slice]' >> test_parent.slice
          echo '# No limits - parent slice for organization' >> test_parent.slice

          if grep -q "Supabase Services Slice" test_parent.slice; then
            echo "✓ Parent slice generation working"
          else
            echo "✗ Parent slice generation failed"
            exit 1
          fi

          rm -f test_slice.slice test_parent.slice
          echo "Systemd slice file generation test completed"
        shell: bash

      - name: Test Docker Compose override generation
        run: |
          cd docker
          echo "Testing Docker Compose override generation..."

          # Test the override file generation logic
          SLICE_NAME="test-slice"

          # Generate override file content (from script logic)
          echo '# Temporary override to set cgroup_parent for all services' > test_override.yml
          echo 'services:' >> test_override.yml
          echo '  studio:' >> test_override.yml
          echo '    cgroup_parent: test-slice.slice' >> test_override.yml
          echo '  kong:' >> test_override.yml
          echo '    cgroup_parent: test-slice.slice' >> test_override.yml
          echo '  auth:' >> test_override.yml
          echo '    cgroup_parent: test-slice.slice' >> test_override.yml
          echo '  rest:' >> test_override.yml
          echo '    cgroup_parent: test-slice.slice' >> test_override.yml
          echo '  storage:' >> test_override.yml
          echo '    cgroup_parent: test-slice.slice' >> test_override.yml
          echo '  imgproxy:' >> test_override.yml
          echo '    cgroup_parent: test-slice.slice' >> test_override.yml
          echo '  meta:' >> test_override.yml
          echo '    cgroup_parent: test-slice.slice' >> test_override.yml
          echo '  supavisor:' >> test_override.yml
          echo '    cgroup_parent: test-slice.slice' >> test_override.yml
          echo '  db:' >> test_override.yml
          echo '    cgroup_parent: test-slice.slice' >> test_override.yml

          # Validate override file structure
          service_count=$(grep -c "cgroup_parent:" test_override.yml)
          expected_services=9

          if [ "$service_count" -eq "$expected_services" ]; then
            echo "✓ Docker Compose override generation working ($service_count services)"
          else
            echo "✗ Docker Compose override generation failed (found $service_count, expected $expected_services)"
            exit 1
          fi

          # Test YAML syntax of override file
          if command -v python3 >/dev/null 2>&1; then
            if python3 -c "import yaml; yaml.safe_load(open('test_override.yml'))" 2>/dev/null; then
              echo "✓ Override file has valid YAML syntax"
            else
              echo "⚠ Override file YAML validation failed (may be missing python3-yaml)"
            fi
          else
            echo "⚠ Python3 not available for YAML validation"
          fi

          rm -f test_override.yml
          echo "Docker Compose override generation test completed"
        shell: bash

      - name: Test resource limit calculations
        run: |
          cd docker
          echo "Testing resource limit calculations..."

          # Test the plan resource logic from the script
          declare -A test_limits=(
            ["512mb"]="512M 100%"
            ["1gb"]="1G 100%"
            ["2gb"]="2G 100%"
            ["4gb"]="4G 200%"
          )

          for plan in "${!test_limits[@]}"; do
            expected="${test_limits[$plan]}"
            IFS=' ' read -r mem_limit cpu_quota <<< "$expected"

            echo "Testing plan: $plan (Memory: $mem_limit, CPU: $cpu_quota)"

            # Validate memory limit format
            if [[ "$mem_limit" =~ ^[0-9]+[MG]?$ ]]; then
              echo "  ✓ Memory limit format valid: $mem_limit"
            else
              echo "  ✗ Memory limit format invalid: $mem_limit"
              exit 1
            fi

            # Validate CPU quota format
            if [[ "$cpu_quota" =~ ^[0-9]+%$ ]]; then
              echo "  ✓ CPU quota format valid: $cpu_quota"
            else
              echo "  ✗ CPU quota format invalid: $cpu_quota"
              exit 1
            fi
          done

          echo "Resource limit calculations test completed"
        shell: bash

      - name: Test platform-specific paths (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          cd docker
          echo "Testing Linux systemd path logic..."

          # Test systemd path detection
          if [ -d /etc/systemd/system ]; then
            echo "✓ Systemd path /etc/systemd/system exists"
          else
            echo "⚠ Systemd path not found (expected on runners without systemd)"
          fi

          # Test systemctl command availability
          if command -v systemctl >/dev/null 2>&1; then
            echo "✓ systemctl command available"

            # Test systemctl commands (without actually running them with sudo)
            echo "Testing systemctl command syntax..."
            if systemctl --version >/dev/null 2>&1; then
              echo "✓ systemctl working correctly"
            else
              echo "⚠ systemctl not functional (expected on some runners)"
            fi
          else
            echo "⚠ systemctl command not available (expected on non-systemd systems)"
          fi

          echo "Linux systemd path test completed"
        shell: bash

      - name: Test platform-specific paths (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          cd docker
          echo "Testing macOS non-systemd fallback logic..."

          # Test that macOS follows the non-systemd path
          if command -v systemctl >/dev/null 2>&1 && [ -d /etc/systemd/system ]; then
            echo "⚠ Systemd detected on macOS (unexpected)"
          else
            echo "✓ Non-systemd path correctly detected on macOS"
            echo "✓ Fallback logic will be used"
          fi

          # Test that script handles macOS gracefully
          echo "Testing macOS compatibility..."
          if ./do-limits.sh --help >/dev/null 2>&1; then
            echo "✓ Script runs without errors on macOS"
          else
            echo "✗ Script failed on macOS"
            exit 1
          fi

          echo "macOS fallback test completed"
        shell: bash

      - name: Test platform-specific paths (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          cd docker
          echo "Testing Windows compatibility..."

          # Test that Windows follows the non-systemd path
          if command -v systemctl >/dev/null 2>&1 && [ -d /etc/systemd/system ]; then
            echo "⚠ Systemd detected on Windows (unexpected)"
          else
            echo "✓ Non-systemd path correctly detected on Windows"
            echo "✓ Fallback logic will be used"
          fi

          # Test that script handles Windows gracefully
          echo "Testing Windows compatibility..."
          if ./do-limits.sh --help >/dev/null 2>&1; then
            echo "✓ Script runs without errors on Windows"
          else
            echo "✗ Script failed on Windows"
            exit 1
          fi

          echo "Windows compatibility test completed"
        shell: bash

      - name: Validate script syntax
        run: |
          cd docker
          echo "Validating shell script syntax..."
          bash -n do-limits.sh
          echo "Syntax validation passed"
        shell: bash

      - name: Check for common issues
        run: |
          cd docker
          echo "Checking for common script issues..."

          # Check for proper line endings
          if file do-limits.sh | grep -q "CRLF"; then
            echo "WARNING: File has CRLF line endings"
          fi

          # Check for executable permission
          if [ -x do-limits.sh ]; then
            echo "✓ Script is executable"
          else
            echo "✗ Script is not executable"
            exit 1
          fi

          # Check for basic required functions
          if grep -q "has_systemd" do-limits.sh; then
            echo "✓ Systemd detection function found"
          else
            echo "✗ Systemd detection function missing"
            exit 1
          fi

          echo "Common issues check completed"
        shell: bash

      - name: Test resource limit configurations
        if: env.skip_docker_tests != 'true'
        run: |
          cd docker
          echo "Testing resource limit configurations..."

          # Test that all expected plans are available
          expected_plans=("512mb" "1gb" "2gb" "4gb" "unlimited")

          for plan in "${expected_plans[@]}"; do
            echo "Testing plan: $plan"
            if ./do-limits.sh $plan --dry-run 2>/dev/null; then
              echo "✓ Plan $plan is valid"
            else
              echo "⚠ Plan $plan failed (may be expected on some platforms)"
            fi
          done

          echo "Resource limit configurations test completed"
        shell: bash